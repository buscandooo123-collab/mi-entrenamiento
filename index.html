<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Mi Entrenamiento</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
            min-height: calc(100vh - 20px);
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 { font-size: 22px; margin-bottom: 4px; }
        .header p { opacity: 0.9; font-size: 12px; }
        
        .sync-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            margin-top: 8px;
            background: rgba(255,255,255,0.2);
        }
        
        .sync-status.online { background: #28a745; }
        .sync-status.offline { background: #dc3545; }
        .sync-status.syncing { background: #ffc107; color: #000; }
        
        .top-nav {
            display: flex;
            background: #2d3748;
        }
        
        .top-nav-btn {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            border: none;
            background: none;
            color: #a0aec0;
        }
        
        .top-nav-btn.active {
            background: #667eea;
            color: white;
        }
        
        .main-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .main-tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 11px;
            border: none;
            background: none;
            color: #6c757d;
            position: relative;
        }
        
        .main-tab.active {
            background: white;
            color: #667eea;
        }
        
        .main-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #667eea;
        }
        
        .sub-tabs {
            display: flex;
            background: #f1f3f5;
            padding: 0 8px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .sub-tab {
            padding: 10px 16px;
            cursor: pointer;
            font-weight: 600;
            font-size: 11px;
            border: none;
            background: none;
            color: #868e96;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }
        
        .sub-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .content {
            padding: 12px;
            max-height: calc(100vh - 220px);
            overflow-y: auto;
        }
        
        .page, .section, .routine { display: none; }
        .page.active, .section.active, .routine.active { display: block; }
        
        .muscle-group { margin-bottom: 16px; }
        .muscle-group h3 {
            color: #667eea;
            font-size: 14px;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .exercise {
            background: #f8f9fa;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
        }
        
        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            gap: 6px;
        }
        
        .exercise-name {
            font-weight: 600;
            color: #2d3748;
            font-size: 13px;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            flex: 1;
        }
        
        .exercise-name:hover {
            background: #e9ecef;
        }
        
        .exercise-name-input {
            font-weight: 600;
            font-size: 13px;
            padding: 4px 8px;
            border: 2px solid #667eea;
            border-radius: 4px;
            flex: 1;
            display: none;
            width: 100%;
        }
        
        .exercise-sets {
            color: #6c757d;
            font-size: 10px;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
        }
        
        .exercise-inputs {
            display: flex;
            gap: 8px;
            margin-bottom: 6px;
        }
        
        .weight-input, .notes-input {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        
        .weight-input { flex: 0 0 auto; }
        .notes-input { flex: 1; }
        
        .weight-input label, .notes-input label {
            font-size: 10px;
            color: #6c757d;
        }
        
        .weight-input input {
            width: 55px;
            padding: 6px;
            border: 2px solid #e9ecef;
            border-radius: 4px;
            font-size: 13px;
            text-align: center;
        }
        
        .notes-input textarea {
            flex: 1;
            padding: 6px;
            border: 2px solid #e9ecef;
            border-radius: 4px;
            font-size: 11px;
            font-family: inherit;
            resize: none;
            height: 30px;
        }
        
        .weight-input input:focus, .notes-input textarea:focus, .exercise-name-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .history {
            margin-top: 6px;
            padding: 6px;
            background: white;
            border-radius: 4px;
            font-size: 10px;
        }
        
        .history strong { color: #495057; display: block; margin-bottom: 4px; }
        
        .history-item {
            background: #e7f3ff;
            border-radius: 4px;
            padding: 4px 6px;
            margin-bottom: 4px;
            color: #0c5460;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-weight { font-weight: 600; }
        .history-date { font-size: 9px; color: #5a6c7d; }
        .history-notes { font-size: 9px; font-style: italic; margin-left: 8px; flex: 1; }
        .no-history { color: #adb5bd; font-style: italic; }
        
        .save-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 12px;
            width: 100%;
        }
        
        .save-btn:disabled { background: #adb5bd; }
        
        .message {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: none;
            text-align: center;
            font-weight: 600;
            font-size: 12px;
        }
        
        .message.success { background: #28a745; color: white; }
        .message.warning { background: #ffc107; color: #000; }
        .message.info { background: #17a2b8; color: white; }
        .message.show { display: block; }
        
        /* Stats Page */
        .stats-page { padding: 16px; }
        .stats-header { text-align: center; margin-bottom: 20px; }
        .stats-header h2 { color: #667eea; font-size: 20px; margin-bottom: 4px; }
        .stats-header p { color: #6c757d; font-size: 12px; }
        
        .stats-grid {
            display: grid;
            gap: 12px;
        }
        
        .stats-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 14px;
            border-left: 4px solid #667eea;
        }
        
        .stats-card h3 {
            color: #2d3748;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .stats-card .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #dee2e6;
            font-size: 12px;
        }
        
        .stats-card .stat-row:last-of-type { border-bottom: none; }
        .stats-card .stat-label { color: #6c757d; }
        .stats-card .stat-value { font-weight: 700; color: #2d3748; }
        
        .stats-card .sessions-btn {
            margin-top: 10px;
            padding: 8px;
            width: 100%;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .stats-card .clear-btn {
            margin-top: 6px;
            padding: 6px;
            width: 100%;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 10px;
            cursor: pointer;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 16px;
            border-radius: 12px;
            max-width: 350px;
            width: 90%;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .modal-header h3 { color: #667eea; font-size: 16px; }
        .close-modal { background: none; border: none; font-size: 20px; cursor: pointer; color: #6c757d; }
        
        .session-item {
            background: #f8f9fa;
            padding: 10px;
            margin-bottom: 6px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .session-date { font-weight: 600; font-size: 12px; }
        
        .delete-session-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
        }
        
        .no-sessions { text-align: center; color: #6c757d; padding: 16px; font-size: 12px; }
        
        /* Muay Thai */
        .round-section {
            background: #f8f9fa;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }
        
        .round-section h3 { color: #667eea; margin-bottom: 6px; font-size: 13px; }
        .exercise-list { list-style: none; }
        .exercise-list li { padding: 3px 0 3px 14px; position: relative; color: #495057; font-size: 11px; }
        .exercise-list li::before { content: '‚ñ∏'; position: absolute; left: 0; color: #667eea; }
        .timer-info { background: white; padding: 4px 8px; border-radius: 4px; margin-bottom: 6px; font-weight: 600; color: #667eea; font-size: 11px; display: inline-block; }
        
        .completion-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
        }
        
        .completion-checkbox input { width: 18px; height: 18px; }
        .completion-checkbox label { font-weight: 600; color: #495057; font-size: 12px; }
        
        .edit-hint {
            font-size: 10px;
            color: #6c757d;
            text-align: center;
            margin-bottom: 8px;
            padding: 6px;
            background: #fff3cd;
            border-radius: 4px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e9ecef;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí™ Mi Entrenamiento</h1>
            <p>Sincronizado en la nube</p>
            <div id="sync-status" class="sync-status">üîÑ Conectando...</div>
        </div>

        <div class="top-nav">
            <button class="top-nav-btn active" onclick="APP.switchPage('entrenar')">üèãÔ∏è Entrenar</button>
            <button class="top-nav-btn" onclick="APP.switchPage('estadisticas')">üìä Estad√≠sticas</button>
        </div>

        <div id="page-entrenar" class="page active">
            <div class="main-tabs">
                <button class="main-tab active" data-section="pierna">ü¶µ Pierna</button>
                <button class="main-tab" data-section="superior">üí™ Superior</button>
                <button class="main-tab" data-section="muaythai">ü•ä Muay Thai</button>
            </div>

            <div class="content">
                <div id="msg-success" class="message success">‚úÖ Guardado</div>
                <div id="msg-warning" class="message warning">‚ö†Ô∏è Ya guardaste hoy</div>
                <div id="msg-info" class="message info">‚ÑπÔ∏è Actualizado</div>
                <div id="APP_CONTAINER">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Cargando datos...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-estadisticas" class="page">
            <div class="stats-page">
                <div class="stats-header">
                    <h2>üìä Mis Estad√≠sticas</h2>
                    <p>Resumen de entrenamientos</p>
                </div>
                <div id="STATS_CONTAINER" class="stats-grid"></div>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìÖ Sesiones</h3>
                <button class="close-modal" onclick="APP.closeModal()">√ó</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDe8vd3_FWWMhOgyL3qdukVXcJI_c6zTWM",
            authDomain: "mi-entrenamiento-cc518.firebaseapp.com",
            projectId: "mi-entrenamiento-cc518",
            storageBucket: "mi-entrenamiento-cc518.firebasestorage.app",
            messagingSenderId: "144797223454",
            appId: "1:144797223454:web:f6e20a240d1279361ebc0f"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Enable offline persistence
        db.enablePersistence().catch(err => {
            console.log('Persistence error:', err);
        });

        const ROUTINES = {
            pierna: {
                name: "Pierna",
                icon: "ü¶µ",
                days: {
                    dia1: {
                        name: "D√≠a 1",
                        groups: {
                            "üçë Gl√∫teos": [
                                { id: "p1-hip", name: "Hip Thrust con barra", sets: "4√ó8-10" },
                                { id: "p1-patada", name: "Patada gl√∫teo polea", sets: "3√ó12-15" }
                            ],
                            "ü¶µ Cu√°driceps": [
                                { id: "p1-sentadilla", name: "Sentadilla con barra", sets: "4√ó8-10" },
                                { id: "p1-extensiones", name: "Extensiones m√°quina", sets: "3√ó12-15" }
                            ],
                            "üèãÔ∏è Femorales": [
                                { id: "p1-rumano", name: "Peso muerto rumano", sets: "4√ó8-10" },
                                { id: "p1-curl", name: "Curl femoral", sets: "3√ó12" }
                            ],
                            "üîÑ Aductores": [
                                { id: "p1-aductores", name: "M√°quina aductores", sets: "3√ó15-20" },
                                { id: "p1-sumo", name: "Sentadilla sumo", sets: "4√ó10-12" }
                            ],
                            "‚ÜîÔ∏è Abductores": [
                                { id: "p1-abductores", name: "M√°quina abductores", sets: "3√ó15-20" }
                            ],
                            "ü¶∂ Pantorrilla": [
                                { id: "p1-elev-pie", name: "Elevaci√≥n tal√≥n pie", sets: "4√ó15-20" },
                                { id: "p1-elev-sent", name: "Elevaci√≥n sentada", sets: "3√ó15-20" }
                            ]
                        }
                    },
                    dia2: {
                        name: "D√≠a 2",
                        groups: {
                            "üçë Gl√∫teos": [
                                { id: "p2-bulgara", name: "Sentadilla b√∫lgara", sets: "3√ó10-12" },
                                { id: "p2-hip-pausa", name: "Hip Thrust pausa", sets: "4√ó8-10" }
                            ],
                            "ü¶µ Cu√°driceps": [
                                { id: "p2-prensa", name: "Prensa", sets: "4√ó12" },
                                { id: "p2-hack", name: "Hack squat", sets: "3√ó10-12" }
                            ],
                            "üèãÔ∏è Femorales": [
                                { id: "p2-rigidas", name: "Peso muerto r√≠gidas", sets: "3√ó10-12" },
                                { id: "p2-curl-sent", name: "Curl femoral sentado", sets: "3√ó12-15" }
                            ],
                            "‚ÜîÔ∏è Abductores": [
                                { id: "p2-abductores", name: "M√°quina abductores", sets: "4√ó15-20" },
                                { id: "p2-abd-polea", name: "Abducci√≥n polea", sets: "3√ó20" }
                            ],
                            "üîÑ Aductores": [
                                { id: "p2-aductores", name: "M√°quina aductores", sets: "3√ó15-20" }
                            ],
                            "ü¶∂ Pantorrilla": [
                                { id: "p2-gem-prensa", name: "Gemelo prensa", sets: "4√ó20" },
                                { id: "p2-gem-maq", name: "Gemelo m√°quina", sets: "3√ó15-20" }
                            ]
                        }
                    }
                }
            },
            superior: {
                name: "Superior",
                icon: "üí™",
                days: {
                    dia1: {
                        name: "D√≠a 1",
                        groups: {
                            "üí™ Espalda": [
                                { id: "s1-jalon", name: "Jal√≥n pecho ancho", sets: "4√ó8-12" },
                                { id: "s1-dominadas", name: "Dominadas asistidas", sets: "3√ó6-10" },
                                { id: "s1-remo-maq", name: "Remo m√°quina", sets: "3√ó10-12" },
                                { id: "s1-pullover", name: "Pull-over polea", sets: "3√ó12-15" }
                            ],
                            "üèãÔ∏è Pecho": [
                                { id: "s1-press-plano", name: "Press plano barra", sets: "4√ó8-10" },
                                { id: "s1-press-incl", name: "Press inclinado", sets: "3√ó10-12" },
                                { id: "s1-aperturas", name: "Aperturas", sets: "3√ó12-15" }
                            ],
                            "üî∫ Hombro": [
                                { id: "s1-militar", name: "Press militar", sets: "4√ó8-10" },
                                { id: "s1-elev-lat", name: "Elevaciones laterales", sets: "4√ó12-15" },
                                { id: "s1-elev-front", name: "Elevaciones frontales", sets: "3√ó12" }
                            ],
                            "üí™ Tr√≠ceps": [
                                { id: "s1-press-cerr", name: "Press cerrado", sets: "3√ó8-10" },
                                { id: "s1-ext-polea", name: "Extensi√≥n polea", sets: "3√ó12" },
                                { id: "s1-fondos", name: "Fondos banca", sets: "3√ó10-12" }
                            ],
                            "ü§ú Antebrazo": [
                                { id: "s1-curl-inv", name: "Curl inverso", sets: "3√ó12" },
                                { id: "s1-curl-mun", name: "Curl mu√±eca", sets: "3√ó15-20" }
                            ]
                        }
                    },
                    dia2: {
                        name: "D√≠a 2",
                        groups: {
                            "üí™ Espalda": [
                                { id: "s2-remo-barra", name: "Remo barra", sets: "4√ó8-10" },
                                { id: "s2-remo-1mano", name: "Remo una mano", sets: "3√ó10-12" },
                                { id: "s2-remo-tbar", name: "Remo T-bar", sets: "3√ó10" },
                                { id: "s2-face-pull", name: "Face pull", sets: "3√ó15" }
                            ],
                            "üèãÔ∏è Pecho": [
                                { id: "s2-press-incl-bar", name: "Press inclinado barra", sets: "4√ó8-10" },
                                { id: "s2-press-maq", name: "Press m√°quina", sets: "3√ó10-12" },
                                { id: "s2-apert-incl", name: "Aperturas inclinadas", sets: "3√ó12-15" }
                            ],
                            "üî∫ Hombro": [
                                { id: "s2-pajaros", name: "P√°jaros posterior", sets: "4√ó12-15" },
                                { id: "s2-remo-menton", name: "Remo ment√≥n", sets: "3√ó10-12" },
                                { id: "s2-arnold", name: "Press Arnold", sets: "3√ó10" }
                            ],
                            "üí™ B√≠ceps": [
                                { id: "s2-curl-barra", name: "Curl barra", sets: "4√ó8-12" },
                                { id: "s2-curl-mart", name: "Curl martillo", sets: "3√ó12" }
                            ],
                            "ü§ú Antebrazo": [
                                { id: "s2-farmer", name: "Farmer walk", sets: "2√ó45s" },
                                { id: "s2-curl-inv", name: "Curl mu√±eca inv", sets: "3√ó12-15" }
                            ]
                        }
                    }
                }
            },
            muaythai: {
                name: "Muay Thai",
                icon: "ü•ä",
                days: {
                    dia1: {
                        name: "D√≠a 1 - Boxeo",
                        rounds: [
                            { id: "mt1-calent", name: "CALENTAMIENTO", timer: "6 min", exercises: ["Cuerda", "Shadowboxing", "Rodillas altas", "Movilidad", "Jumping jacks", "Desplazamientos"] },
                            { id: "mt1-r1", name: "ROUND 1 - Reflejos", timer: "30s/15s √ó8", exercises: ["Jabs", "Slips", "Cross", "Esquivas", "Uppercuts", "Ganchos"] },
                            { id: "mt1-r2", name: "ROUND 2 - Potencia", timer: "40s/20s √ó6", exercises: ["Jab+cross", "Hook h√≠gado", "Uppercut", "Cross+gancho"] },
                            { id: "mt1-r3", name: "ROUND 3 - Cardio", timer: "30s/15s √ó10", exercises: ["Burpees", "Mountain climbers", "Sprint", "Saltos", "Skipping"] },
                            { id: "mt1-r4", name: "ROUND 4 - Core", timer: "5 min", exercises: ["Plancha", "Russian twist", "Elevaciones"] },
                            { id: "mt1-estir", name: "ESTIRAMIENTO", timer: "5 min", exercises: [] }
                        ]
                    },
                    dia2: {
                        name: "D√≠a 2 - Patadas",
                        rounds: [
                            { id: "mt2-calent", name: "CALENTAMIENTO", timer: "6 min", exercises: ["Shadowboxing", "Patadas bajas", "Rodillas", "Movilidad", "Skipping"] },
                            { id: "mt2-r1", name: "ROUND 1 - Potencia", timer: "40s/20s √ó6", exercises: ["Patada lateral", "Low kick", "Teep", "Roundhouse"] },
                            { id: "mt2-r2", name: "ROUND 2 - Altas", timer: "30s/15s √ó8", exercises: ["Patada alta", "Side kick", "Circular", "Axe kick"] },
                            { id: "mt2-r3", name: "ROUND 3 - Agilidad", timer: "30s/15s √ó10", exercises: ["Escalera", "Saltos", "Zig-zag", "Cambio guardia"] },
                            { id: "mt2-r4", name: "ROUND 4 - Flexibilidad", timer: "7 min", exercises: ["Apertura lateral", "Mariposa", "Isquios", "Pigeon"] },
                            { id: "mt2-enfr", name: "ENFRIAMIENTO", timer: "4 min", exercises: [] }
                        ]
                    }
                }
            }
        };

        const APP = {
            isSaving: false,
            currentPage: 'entrenar',
            data: {},
            
            async init() {
                this.setupListeners();
                this.renderAll();
                await this.loadAllData();
                this.updateSyncStatus('online');
                
                // Listen for connection changes
                window.addEventListener('online', () => this.updateSyncStatus('online'));
                window.addEventListener('offline', () => this.updateSyncStatus('offline'));
            },
            
            updateSyncStatus(status) {
                const el = document.getElementById('sync-status');
                el.className = 'sync-status ' + status;
                if (status === 'online') el.textContent = '‚úÖ Conectado';
                else if (status === 'offline') el.textContent = 'üì¥ Sin conexi√≥n';
                else if (status === 'syncing') el.textContent = 'üîÑ Sincronizando...';
            },
            
            async loadAllData() {
                try {
                    const snapshot = await db.collection('workout-data').get();
                    snapshot.forEach(doc => {
                        this.data[doc.id] = doc.data();
                    });
                    
                    ['pierna-dia1', 'pierna-dia2', 'superior-dia1', 'superior-dia2', 'muaythai-dia1', 'muaythai-dia2'].forEach(r => this.loadRoutine(r));
                } catch (e) {
                    console.error('Error loading:', e);
                }
            },
            
            async saveToFirebase(key, value) {
                try {
                    this.updateSyncStatus('syncing');
                    await db.collection('workout-data').doc(key).set(value, { merge: true });
                    this.data[key] = { ...this.data[key], ...value };
                    this.updateSyncStatus('online');
                    return true;
                } catch (e) {
                    console.error('Save error:', e);
                    this.updateSyncStatus('offline');
                    return false;
                }
            },
            
            async getFromFirebase(key) {
                if (this.data[key]) return this.data[key];
                try {
                    const doc = await db.collection('workout-data').doc(key).get();
                    if (doc.exists) {
                        this.data[key] = doc.data();
                        return doc.data();
                    }
                } catch (e) {
                    console.error('Get error:', e);
                }
                return null;
            },
            
            async getExerciseHistory(exId) {
                const data = await this.getFromFirebase(exId);
                return data?.history || [];
            },
            
            async getSessions(routineId) {
                const data = await this.getFromFirebase(`${routineId}-sessions`);
                return data?.sessions || [];
            },
            
            async getExerciseName(exId, defaultName) {
                const data = await this.getFromFirebase('custom-names');
                return data?.[exId] || defaultName;
            },
            
            async saveExerciseName(exId, newName) {
                const names = (await this.getFromFirebase('custom-names')) || {};
                names[exId] = newName;
                await this.saveToFirebase('custom-names', names);
            },
            
            editExerciseName(exId) {
                const nameSpan = document.querySelector(`.exercise-name[data-exid="${exId}"]`);
                const input = document.querySelector(`.exercise-name-input[data-exid="${exId}"]`);
                if (nameSpan && input) {
                    nameSpan.style.display = 'none';
                    input.style.display = 'block';
                    input.value = nameSpan.textContent;
                    input.focus();
                    input.select();
                }
            },
            
            async saveEditedName(exId) {
                const nameSpan = document.querySelector(`.exercise-name[data-exid="${exId}"]`);
                const input = document.querySelector(`.exercise-name-input[data-exid="${exId}"]`);
                if (nameSpan && input) {
                    const newName = input.value.trim();
                    if (newName) {
                        nameSpan.textContent = newName;
                        await this.saveExerciseName(exId, newName);
                        this.showMsg('info', '‚úèÔ∏è Actualizado');
                    }
                    nameSpan.style.display = 'block';
                    input.style.display = 'none';
                }
            },
            
            showMsg(type, text) {
                const msg = document.getElementById('msg-' + type);
                if (msg) {
                    msg.textContent = text;
                    msg.classList.add('show');
                    setTimeout(() => msg.classList.remove('show'), 2500);
                }
            },
            
            switchPage(page) {
                this.currentPage = page;
                document.querySelectorAll('.top-nav-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`.top-nav-btn[onclick*="${page}"]`).classList.add('active');
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(`page-${page}`).classList.add('active');
                if (page === 'estadisticas') this.renderStats();
            },
            
            async renderStats() {
                const allRoutines = [
                    { id: 'pierna-dia1', name: 'Pierna D√≠a 1', icon: 'ü¶µ' },
                    { id: 'pierna-dia2', name: 'Pierna D√≠a 2', icon: 'ü¶µ' },
                    { id: 'superior-dia1', name: 'Superior D√≠a 1', icon: 'üí™' },
                    { id: 'superior-dia2', name: 'Superior D√≠a 2', icon: 'üí™' },
                    { id: 'muaythai-dia1', name: 'Muay Thai D√≠a 1', icon: 'ü•ä' },
                    { id: 'muaythai-dia2', name: 'Muay Thai D√≠a 2', icon: 'ü•ä' }
                ];
                
                let html = '';
                for (const routine of allRoutines) {
                    const sessions = await this.getSessions(routine.id);
                    const lastSession = sessions.length > 0 ? sessions[sessions.length - 1] : '--';
                    
                    html += `
                        <div class="stats-card">
                            <h3>${routine.icon} ${routine.name}</h3>
                            <div class="stat-row">
                                <span class="stat-label">Total:</span>
                                <span class="stat-value">${sessions.length}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">√öltima:</span>
                                <span class="stat-value">${lastSession}</span>
                            </div>
                            <button class="sessions-btn" onclick="APP.showModal('${routine.id}')">üìã Ver Sesiones</button>
                            <button class="clear-btn" onclick="APP.clearHistory('${routine.id}')">üóëÔ∏è Limpiar</button>
                        </div>
                    `;
                }
                document.getElementById('STATS_CONTAINER').innerHTML = html;
            },
            
            async canSaveToday(routineId) {
                const today = new Date().toLocaleDateString('es-MX');
                const sessions = await this.getSessions(routineId);
                return !sessions.includes(today);
            },
            
            async showModal(routineId) {
                const sessions = await this.getSessions(routineId);
                const body = document.getElementById('modal-body');
                
                if (sessions.length === 0) {
                    body.innerHTML = '<div class="no-sessions">No hay sesiones</div>';
                } else {
                    body.innerHTML = sessions.slice().reverse().map(date => `
                        <div class="session-item">
                            <span class="session-date">üìÖ ${date}</span>
                            <button class="delete-session-btn" onclick="APP.deleteSession('${routineId}', '${date}')">üóëÔ∏è</button>
                        </div>
                    `).join('');
                }
                
                document.getElementById('modal').classList.add('show');
                this.currentRoutine = routineId;
            },
            
            closeModal() {
                document.getElementById('modal').classList.remove('show');
            },
            
            async deleteSession(routineId, dateToDelete) {
                if (!confirm(`¬øEliminar sesi√≥n del ${dateToDelete}?`)) return;
                
                let sessions = await this.getSessions(routineId);
                sessions = sessions.filter(d => d !== dateToDelete);
                await this.saveToFirebase(`${routineId}-sessions`, { sessions });
                
                this.showMsg('info', 'üóëÔ∏è Eliminada');
                this.loadRoutine(routineId);
                this.showModal(routineId);
                if (this.currentPage === 'estadisticas') this.renderStats();
            },
            
            renderWeightRoutine(routineId, routine) {
                let html = `<div class="edit-hint">üí° Toca el nombre para editarlo</div>`;
                
                for (const [groupName, exercises] of Object.entries(routine.groups)) {
                    html += `<div class="muscle-group"><h3>${groupName}</h3>`;
                    exercises.forEach(ex => {
                        const exId = `${routineId}-${ex.id}`;
                        html += `
                            <div class="exercise" data-id="${exId}">
                                <div class="exercise-header">
                                    <span class="exercise-name" data-exid="${exId}" onclick="APP.editExerciseName('${exId}')">${ex.name}</span>
                                    <input type="text" class="exercise-name-input" data-exid="${exId}" 
                                           onblur="APP.saveEditedName('${exId}')" 
                                           onkeypress="if(event.key==='Enter')this.blur()">
                                    <span class="exercise-sets">${ex.sets}</span>
                                </div>
                                <div class="exercise-inputs">
                                    <div class="weight-input">
                                        <label>kg:</label>
                                        <input type="number" step="2.5" min="0" class="weight-field">
                                    </div>
                                    <div class="notes-input">
                                        <textarea class="notes-field" placeholder="Notas..."></textarea>
                                    </div>
                                </div>
                                <div class="history"></div>
                            </div>
                        `;
                    });
                    html += `</div>`;
                }
                
                html += `<button class="save-btn" onclick="APP.saveWorkout('${routineId}')">üíæ Guardar</button>`;
                return html;
            },
            
            renderMuayThaiRoutine(routineId, routine) {
                let html = '';
                routine.rounds.forEach(round => {
                    html += `
                        <div class="round-section">
                            <h3>üî• ${round.name}</h3>
                            <span class="timer-info">‚è±Ô∏è ${round.timer}</span>
                            ${round.exercises.length ? `<ul class="exercise-list">${round.exercises.map(e => `<li>${e}</li>`).join('')}</ul>` : ''}
                            <div class="completion-checkbox">
                                <input type="checkbox" id="${routineId}-${round.id}" data-id="${routineId}-${round.id}">
                                <label for="${routineId}-${round.id}">‚úÖ Completado</label>
                            </div>
                        </div>
                    `;
                });
                html += `<button class="save-btn" onclick="APP.saveWorkout('${routineId}')">üíæ Guardar</button>`;
                return html;
            },
            
            renderAll() {
                let html = '';
                for (const [sectionKey, section] of Object.entries(ROUTINES)) {
                    html += `<div id="${sectionKey}-section" class="section ${sectionKey === 'pierna' ? 'active' : ''}">`;
                    html += `<div class="sub-tabs">`;
                    let i = 0;
                    for (const [dayKey, day] of Object.entries(section.days)) {
                        html += `<button class="sub-tab ${i === 0 ? 'active' : ''}" data-section="${sectionKey}" data-day="${dayKey}">${day.name}</button>`;
                        i++;
                    }
                    html += `</div>`;
                    
                    i = 0;
                    for (const [dayKey, day] of Object.entries(section.days)) {
                        const routineId = `${sectionKey}-${dayKey}`;
                        html += `<div id="${routineId}" class="routine ${i === 0 ? 'active' : ''}">`;
                        html += sectionKey === 'muaythai' ? this.renderMuayThaiRoutine(routineId, day) : this.renderWeightRoutine(routineId, day);
                        html += `</div>`;
                        i++;
                    }
                    html += `</div>`;
                }
                document.getElementById('APP_CONTAINER').innerHTML = html;
            },
            
            async loadRoutine(routineId) {
                const container = document.getElementById(routineId);
                if (!container) return;
                
                for (const exercise of container.querySelectorAll('.exercise[data-id]')) {
                    const exId = exercise.dataset.id;
                    const history = await this.getExerciseHistory(exId);
                    const weightInput = exercise.querySelector('.weight-field');
                    const notesInput = exercise.querySelector('.notes-field');
                    const historyDiv = exercise.querySelector('.history');
                    const nameSpan = exercise.querySelector('.exercise-name');
                    
                    // Load custom name
                    if (nameSpan) {
                        const customName = await this.getExerciseName(exId, nameSpan.textContent);
                        nameSpan.textContent = customName;
                    }
                    
                    if (history.length > 0) {
                        const last = history[history.length - 1];
                        if (weightInput) weightInput.value = last.weight || '';
                        if (notesInput) notesInput.value = last.notes || '';
                    }
                    
                    if (historyDiv) {
                        if (history.length === 0) {
                            historyDiv.innerHTML = '<strong>üìä Historial:</strong><div class="no-history">Sin registros</div>';
                        } else {
                            historyDiv.innerHTML = '<strong>üìä Historial:</strong>' + history.slice(-5).reverse().map(e => `
                                <div class="history-item">
                                    <span class="history-weight">üí™ ${e.weight}kg</span>
                                    ${e.notes ? `<span class="history-notes">${e.notes}</span>` : ''}
                                    <span class="history-date">${e.date}</span>
                                </div>
                            `).join('');
                        }
                    }
                }
                
                container.querySelectorAll('input[type="checkbox"][data-id]').forEach(cb => cb.checked = false);
            },
            
            async saveWorkout(routineId) {
                if (this.isSaving) return;
                
                const canSave = await this.canSaveToday(routineId);
                if (!canSave) {
                    this.showMsg('warning', '‚ö†Ô∏è Ya guardaste hoy');
                    return;
                }
                
                this.isSaving = true;
                const container = document.getElementById(routineId);
                const saveBtn = container.querySelector('.save-btn');
                if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = '‚è≥...'; }
                
                const today = new Date().toLocaleDateString('es-MX');
                let saved = 0;
                
                for (const exercise of container.querySelectorAll('.exercise[data-id]')) {
                    const exId = exercise.dataset.id;
                    const weight = parseFloat(exercise.querySelector('.weight-field').value);
                    const notes = exercise.querySelector('.notes-field')?.value.trim() || '';
                    
                    if (!isNaN(weight) && weight > 0) {
                        let history = await this.getExerciseHistory(exId);
                        history.push({ weight, notes, date: today });
                        await this.saveToFirebase(exId, { history });
                        saved++;
                        
                        const historyDiv = exercise.querySelector('.history');
                        if (historyDiv) {
                            historyDiv.innerHTML = '<strong>üìä Historial:</strong>' + history.slice(-5).reverse().map(e => `
                                <div class="history-item">
                                    <span class="history-weight">üí™ ${e.weight}kg</span>
                                    ${e.notes ? `<span class="history-notes">${e.notes}</span>` : ''}
                                    <span class="history-date">${e.date}</span>
                                </div>
                            `).join('');
                        }
                    }
                }
                
                for (const cb of container.querySelectorAll('input[type="checkbox"][data-id]')) {
                    if (cb.checked) {
                        let history = await this.getExerciseHistory(cb.dataset.id);
                        history.push({ completed: true, date: today });
                        await this.saveToFirebase(cb.dataset.id, { history });
                        saved++;
                    }
                }
                
                if (saved > 0) {
                    let sessions = await this.getSessions(routineId);
                    if (!sessions.includes(today)) {
                        sessions.push(today);
                        await this.saveToFirebase(`${routineId}-sessions`, { sessions });
                    }
                    this.showMsg('success', '‚úÖ Guardado');
                } else {
                    alert('Ingresa al menos un peso');
                }
                
                setTimeout(() => {
                    this.isSaving = false;
                    if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'üíæ Guardar'; }
                }, 2000);
            },
            
            async clearHistory(routineId) {
                if (!confirm('¬øBorrar TODO el historial?')) return;
                
                await this.saveToFirebase(`${routineId}-sessions`, { sessions: [] });
                
                this.showMsg('info', 'üóëÔ∏è Borrado');
                this.loadRoutine(routineId);
                if (this.currentPage === 'estadisticas') this.renderStats();
            },
            
            setupListeners() {
                document.querySelectorAll('.main-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const section = tab.dataset.section;
                        document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                        document.getElementById(`${section}-section`).classList.add('active');
                        this.loadRoutine(`${section}-${Object.keys(ROUTINES[section].days)[0]}`);
                    });
                });
                
                document.addEventListener('click', e => {
                    if (e.target.classList.contains('sub-tab')) {
                        const section = e.target.dataset.section;
                        const day = e.target.dataset.day;
                        const routineId = `${section}-${day}`;
                        const parent = document.getElementById(`${section}-section`);
                        parent.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
                        e.target.classList.add('active');
                        parent.querySelectorAll('.routine').forEach(r => r.classList.remove('active'));
                        document.getElementById(routineId).classList.add('active');
                        this.loadRoutine(routineId);
                    }
                });
                
                document.getElementById('modal').addEventListener('click', e => {
                    if (e.target.id === 'modal') this.closeModal();
                });
            }
        };
        
        document.addEventListener('DOMContentLoaded', () => APP.init());
    </script>
</body>
</html>
